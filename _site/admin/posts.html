<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ê´€ë¦¬ - ë¸Œë ˆì´ë“ ì˜ ì§€ì‹ ì €ì¥ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">ê²Œì‹œê¸€ ê´€ë¦¬</h1>
                <p class="text-gray-600">ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            <div class="flex gap-4">
                <a href="index.html" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    êµ¬ë…ì ê´€ë¦¬
                </a>
                <button onclick="showNewPostForm()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ìƒˆ ê¸€ ì‘ì„±
                </button>
            </div>
        </header>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-700">ì´ ê²Œì‹œê¸€</h3>
                <p class="text-3xl font-bold text-blue-600" id="totalPosts">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-700">ë°œí–‰ëœ ê¸€</h3>
                <p class="text-3xl font-bold text-green-600" id="publishedPosts">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-700">ì„ì‹œì €ì¥</h3>
                <p class="text-3xl font-bold text-yellow-600" id="draftPosts">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-700">êµ¬ë…ì ì „ìš©</h3>
                <p class="text-3xl font-bold text-purple-600" id="subscriberOnlyPosts">-</p>
            </div>
        </div>

        <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">ê²Œì‹œê¸€ ëª©ë¡</h2>
                    <div class="flex gap-4">
                        <div class="relative">
                            <input type="text" 
                                   id="searchInput" 
                                   placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." 
                                   class="border rounded px-4 py-2 w-64"
                                   onkeyup="handleSearch()">
                            <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <select id="categoryFilter" 
                                onchange="handleFilter()"
                                class="border rounded px-4 py-2">
                            <option value="all">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
                        </select>
                        <select id="statusFilter" 
                                onchange="handleFilter()"
                                class="border rounded px-4 py-2">
                            <option value="all">ëª¨ë“  ìƒíƒœ</option>
                            <option value="published">ë°œí–‰ë¨</option>
                            <option value="draft">ì„ì‹œì €ì¥</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì œëª©</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì¹´í…Œê³ ë¦¬</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‘ì„±ì¼</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="postsList" class="bg-white divide-y divide-gray-200">
                            <!-- ì—¬ê¸°ì— ê²Œì‹œê¸€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        ì´ <span id="totalResults">0</span>ê°œì˜ ê²°ê³¼
                    </div>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">ì´ì „</button>
                        <span id="currentPage" class="px-3 py-1">1 / 1</span>
                        <button onclick="nextPage()" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">ë‹¤ìŒ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²Œì‹œê¸€ ì‘ì„±/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="postModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="fixed inset-0 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">ìƒˆ ê¸€ ì‘ì„±</h3>
                        <button onclick="closePostModal()" class="text-gray-500 hover:text-gray-700">âœ•</button>
                    </div>
                    <form id="postForm" onsubmit="handlePostSubmit(event)">
                        <input type="hidden" id="postId">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ì œëª©</label>
                                <input type="text" 
                                       id="postTitle" 
                                       class="mt-1 block w-full border rounded-md px-3 py-2"
                                       required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ì¹´í…Œê³ ë¦¬</label>
                                    <input type="text" 
                                           id="postCategory" 
                                           class="mt-1 block w-full border rounded-md px-3 py-2"
                                           required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">íƒœê·¸</label>
                                    <input type="text" 
                                           id="postTags" 
                                           class="mt-1 block w-full border rounded-md px-3 py-2"
                                           placeholder="ì‰¼í‘œë¡œ êµ¬ë¶„">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ìš”ì•½</label>
                                <textarea id="postExcerpt" 
                                         class="mt-1 block w-full border rounded-md px-3 py-2"
                                         rows="2"
                                         required></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ë‚´ìš©</label>
                                <textarea id="postContent" class="hidden"></textarea>
                            </div>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                           id="isSubscriberOnly" 
                                           class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-600">êµ¬ë…ì ì „ìš©</span>
                                </label>
                                <div class="flex-grow"></div>
                                <button type="button"
                                        onclick="handleSaveDraft()"
                                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                    ì„ì‹œì €ì¥
                                </button>
                                <button type="submit"
                                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                    ë°œí–‰í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let posts = [];
        let filteredPosts = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let editor = null;
        let categories = new Set();

        // Socket.io ì—°ê²°
        const socket = io('http://localhost:3000');

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        socket.on('newPost', (post) => {
            updatePostsList();
            updateStats();
        });

        socket.on('updatePost', (post) => {
            updatePostsList();
            updateStats();
        });

        socket.on('deletePost', (postId) => {
            updatePostsList();
            updateStats();
        });

        // ê²Œì‹œê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸
        async function updatePostsList() {
            try {
                const response = await fetch('http://localhost:3000/api/posts/admin/posts');
                posts = await response.json();
                filteredPosts = [...posts];
                
                // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                categories = new Set(posts.map(post => post.category));
                updateCategoryFilter();
                
                handleFilter();
                updatePagination();
                displayPosts();
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        async function updateStats() {
            try {
                const response = await fetch('http://localhost:3000/api/posts/admin/posts/stats');
                const stats = await response.json();
                
                document.getElementById('totalPosts').textContent = stats.total;
                document.getElementById('publishedPosts').textContent = stats.published;
                document.getElementById('draftPosts').textContent = stats.draft;
                document.getElementById('subscriberOnlyPosts').textContent = stats.subscriberOnly;
            } catch (error) {
                console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° ì—…ë°ì´íŠ¸
        function updateCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            const currentValue = select.value;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // ìƒˆ ì˜µì…˜ ì¶”ê°€
            categories.forEach(category => {
                const option = new Option(category, category);
                select.add(option);
            });
            
            // ì´ì „ ì„ íƒê°’ ë³µì›
            if (currentValue !== 'all' && categories.has(currentValue)) {
                select.value = currentValue;
            }
        }

        // ê²€ìƒ‰ ì²˜ë¦¬
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            applyFilters(searchTerm);
        }

        // í•„í„° ì²˜ë¦¬
        function handleFilter() {
            applyFilters();
        }

        function applyFilters(searchTerm = document.getElementById('searchInput').value.toLowerCase()) {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;

            filteredPosts = posts.filter(post => {
                const matchesSearch = post.title.toLowerCase().includes(searchTerm);
                const matchesCategory = category === 'all' || post.category === category;
                const matchesStatus = status === 'all' || post.status === status;
                return matchesSearch && matchesCategory && matchesStatus;
            });

            currentPage = 1;
            updatePagination();
            displayPosts();
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePagination() {
            const totalPages = Math.ceil(filteredPosts.length / itemsPerPage);
            document.getElementById('currentPage').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('totalResults').textContent = filteredPosts.length;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayPosts();
                updatePagination();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredPosts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayPosts();
                updatePagination();
            }
        }

        // ê²Œì‹œê¸€ ëª©ë¡ í‘œì‹œ
        function displayPosts() {
            const tbody = document.getElementById('postsList');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pagePosts = filteredPosts.slice(start, end);

            pagePosts.forEach(post => {
                const row = document.createElement('tr');
                const date = new Date(post.createdAt).toLocaleDateString('ko-KR');
                const status = post.status === 'published' ? 
                    '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">ë°œí–‰ë¨</span>' : 
                    '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">ì„ì‹œì €ì¥</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="font-medium text-gray-900">${post.title}</div>
                        ${post.isSubscriberOnly ? '<span class="text-xs text-purple-600">êµ¬ë…ì ì „ìš©</span>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${post.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="editPost('${post._id}')" 
                                class="text-blue-600 hover:text-blue-900 mr-3">ìˆ˜ì •</button>
                        <button onclick="deletePost('${post._id}')" 
                                class="text-red-600 hover:text-red-900">ì‚­ì œ</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ê²Œì‹œê¸€ ì‘ì„± ëª¨ë‹¬
        function showNewPostForm() {
            document.getElementById('modalTitle').textContent = 'ìƒˆ ê¸€ ì‘ì„±';
            document.getElementById('postForm').reset();
            document.getElementById('postId').value = '';
            
            if (!editor) {
                editor = new EasyMDE({
                    element: document.getElementById('postContent'),
                    spellChecker: false,
                    autosave: {
                        enabled: true,
                        uniqueId: 'postEditor'
                    }
                });
            } else {
                editor.value('');
            }
            
            document.getElementById('postModal').classList.remove('hidden');
        }

        // ê²Œì‹œê¸€ ìˆ˜ì •
        async function editPost(id) {
            try {
                const response = await fetch(`http://localhost:3000/api/posts/admin/posts/${id}`);
                const post = await response.json();

                document.getElementById('modalTitle').textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
                document.getElementById('postId').value = post._id;
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postCategory').value = post.category;
                document.getElementById('postTags').value = post.tags.join(', ');
                document.getElementById('postExcerpt').value = post.excerpt;
                document.getElementById('isSubscriberOnly').checked = post.isSubscriberOnly;

                if (!editor) {
                    editor = new EasyMDE({
                        element: document.getElementById('postContent'),
                        spellChecker: false,
                        autosave: {
                            enabled: true,
                            uniqueId: 'postEditor'
                        }
                    });
                }
                editor.value(post.content);

                document.getElementById('postModal').classList.remove('hidden');
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closePostModal() {
            document.getElementById('postModal').classList.add('hidden');
        }

        // ê²Œì‹œê¸€ ì €ì¥
        async function handlePostSubmit(event) {
            event.preventDefault();
            await savePost('published');
        }

        async function handleSaveDraft() {
            await savePost('draft');
        }

        async function savePost(status) {
            try {
                const postId = document.getElementById('postId').value;
                const postData = {
                    title: document.getElementById('postTitle').value,
                    content: editor.value(),
                    excerpt: document.getElementById('postExcerpt').value,
                    category: document.getElementById('postCategory').value,
                    tags: document.getElementById('postTags').value.split(',').map(tag => tag.trim()).filter(Boolean),
                    isSubscriberOnly: document.getElementById('isSubscriberOnly').checked,
                    status
                };

                const url = postId ? 
                    `http://localhost:3000/api/posts/admin/posts/${postId}` :
                    'http://localhost:3000/api/posts/admin/posts';
                
                const response = await fetch(url, {
                    method: postId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(postData)
                });

                if (response.ok) {
                    closePostModal();
                    updatePostsList();
                    updateStats();
                    alert(status === 'published' ? 'ê²Œì‹œê¸€ì´ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì„ì‹œì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ê²Œì‹œê¸€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ê²Œì‹œê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        async function deletePost(id) {
            if (!confirm('ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`http://localhost:3000/api/posts/admin/posts/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    updatePostsList();
                    updateStats();
                    alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            updatePostsList();
            updateStats();
        });
    </script>
</body>
</html> 